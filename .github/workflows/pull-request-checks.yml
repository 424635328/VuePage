# .github/workflows/pull-request-checks.yml
# æœ€ç»ˆæ­£ç¡®ç‰ˆï¼šä½¿ç”¨â€œçœ‹é—¨äººâ€ä»»åŠ¡ï¼Œåªä¸ºè‡ªåŠ¨åŒ– PR è¿è¡Œè´¨é‡æ£€æŸ¥

name: 'Pull Request Checks'

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-labels:
    name: Check PR Labels
    runs-on: ubuntu-latest
    # å°†è¾“å‡ºæƒé™èµ‹äºˆè¿™ä¸ªä»»åŠ¡ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è®¾ç½®ä¸€ä¸ªè¾“å‡ºå€¼ï¼ˆè™½ç„¶æœ¬ä¾‹ä¸­æ²¡ç”¨åˆ°ï¼Œä½†è¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼‰
    permissions:
      contents: read
    outputs:
      # å¯ä»¥å®šä¹‰ä¸€ä¸ªè¾“å‡ºï¼Œä¾›åç»­ä»»åŠ¡ä½¿ç”¨ï¼ˆå¯é€‰ï¼‰
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      # è¿™ä¸ªä»»åŠ¡çš„æ ¸å¿ƒå°±æ˜¯è¿™ä¸ª if æ¡ä»¶
      - id: check
        # åªæœ‰å½“ PR åŒ…å« 'automated-pr' æ ‡ç­¾æ—¶ï¼Œè¿™ä¸ªæ­¥éª¤ï¼ˆä»¥åŠæ•´ä¸ªä»»åŠ¡ï¼‰æ‰ä¼šæˆåŠŸè¿è¡Œ
        if: contains(github.event.pull_request.labels.*.name, 'automated-pr')
        run: |
          echo "PR has the 'automated-pr' label. Proceeding with checks."
          echo "should_run=true" >> $GITHUB_OUTPUT
      # å¦‚æœ if æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸Šé¢çš„æ­¥éª¤ä¼šè¢«è·³è¿‡ï¼Œä»»åŠ¡ä¼šä»¥â€œæˆåŠŸâ€çŠ¶æ€ç»“æŸï¼Œä½†åç»­ä¾èµ–å®ƒçš„ä»»åŠ¡ä¼šå› ä¸ºä¸Šä¸‹æ–‡ä¸æ»¡è¶³è€Œè¢«è·³è¿‡ã€‚

  # ä»»åŠ¡ä¸€ï¼šä»£ç è§„èŒƒå’ŒåŸºç¡€æ£€æŸ¥
  lint:
    name: Code Linter
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ 2: è®©è¿™ä¸ªä»»åŠ¡ä¾èµ–äº 'check-labels' ä»»åŠ¡
    needs: check-labels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run linter
        run: npm run lint

  # ä»»åŠ¡äºŒï¼šè¿è¡Œæµ‹è¯•
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ 2: è®©è¿™ä¸ªä»»åŠ¡ä¹Ÿä¾èµ–äº 'check-labels' ä»»åŠ¡
    needs: check-labels
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test

  # ä»»åŠ¡ä¸‰ï¼šè¿è¡Œæ„å»º
  build:
    name: Verify Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # è¿™ä¸ªä»»åŠ¡ç°åœ¨ä¾èµ–äº lint å’Œ test
    # è€Œ lint å’Œ test éƒ½ä¾èµ–äº check-labelsï¼Œæ‰€ä»¥ä¾èµ–é“¾æ˜¯æ­£ç¡®çš„
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build project
        run: npm run build

  # ä»»åŠ¡å››ï¼šæœ€ç»ˆçŠ¶æ€æ±‡æ€»
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [build] # ä¾èµ–äºæœ€ç»ˆçš„ build ä»»åŠ¡
    permissions: {}
    steps:
      - name: Signal successful completion
        run: echo "âœ… All quality checks for the automated PR have passed successfully!"