# ========================================================================================
# Dependabot Observatory: å…¨è‡ªåŠ¨ Dependabot PR å¤„ç†å·¥ä½œæµ (v3.1 - è¯­æ³•ä¿®å¤ç‰ˆ)
# ========================================================================================
#
# è¿™æ˜¯ä¸€ä¸ªé«˜çº§å·¥ä½œæµï¼Œç”¨äºå…¨è‡ªåŠ¨ç®¡ç† Dependabot æäº¤çš„æ‹‰å–è¯·æ±‚ï¼ˆPRï¼‰ã€‚
# å®ƒæ‰®æ¼”ç€â€œå¤©æ–‡å°â€ï¼ˆObservatoryï¼‰çš„è§’è‰²ï¼Œåœ¨æ‰€æœ‰CIæ£€æŸ¥å®Œæˆåï¼Œæ™ºèƒ½åœ°å†³å®šæ˜¯
# è‡ªåŠ¨åˆå¹¶ã€è¯·æ±‚äººå·¥å®¡æŸ¥è¿˜æ˜¯å…³é—­PRï¼Œå¹¶å‘è¡¨ä¸€ä»½è¯¦ç»†çš„æŠ¥å‘Šã€‚
#
# æ ¸å¿ƒç‰¹æ€§ (v3.1):
#   - å¼•å…¥"å†³ç­–å¼•æ“"ï¼Œå°†æ‰€æœ‰é€»è¾‘åˆ¤æ–­é›†ä¸­å¤„ç†ï¼Œç”Ÿæˆæ˜ç¡®çš„å†³ç­–(MERGE, REVIEW, CLOSE)å’ŒæŠ¥å‘Šã€‚
#   - æä¾›æå…¶è¯¦å°½çš„æŠ¥å‘Šï¼Œæ— è®ºæˆåŠŸã€å¤±è´¥è¿˜æ˜¯éœ€è¦å®¡æŸ¥ï¼Œéƒ½ä¼šæ¸…æ™°åˆ—å‡ºåŸå› å’Œæ£€æŸ¥é¡¹çŠ¶æ€ã€‚
#   - æ™ºèƒ½åŒºåˆ†æœ‰æ— åˆ†æ”¯ä¿æŠ¤è§„åˆ™çš„åœºæ™¯ï¼Œå¹¶é‡‡å–ä¸åŒç­–ç•¥ã€‚
#   - ç»Ÿä¸€çš„æ‰§è¡Œæ­¥éª¤ï¼Œè®©å·¥ä½œæµç»“æ„æ›´æ¸…æ™°ã€‚
#   - ä¿®æ­£äº†YAMLè¯­æ³•ï¼Œç¡®ä¿å·¥ä½œæµå¯ä»¥è¢«æ­£ç¡®è§£æå’Œæ‰§è¡Œã€‚
#
name: Dependabot Observatory

# ----------------------------------------------------------------------------------------
# è§¦å‘å™¨ï¼ˆTriggerï¼‰
# ----------------------------------------------------------------------------------------
on:
  check_suite:
    types:
      - completed

# ----------------------------------------------------------------------------------------
# å¹¶å‘æ§åˆ¶ï¼ˆConcurrencyï¼‰
# ----------------------------------------------------------------------------------------
concurrency:
  group: ${{ github.repository }}-${{ github.event.check_suite.pull_requests[0].number }}-observatory
  cancel-in-progress: true

jobs:
  handle_dependabot_pr:
    # ------------------------------------------------------------------------------------
    # ä½œä¸šæ‰§è¡Œæ¡ä»¶ï¼ˆJob Conditionï¼‰
    # ------------------------------------------------------------------------------------
    if: >
      github.actor == 'dependabot[bot]' &&
      github.event.check_suite.pull_requests[0]
    runs-on: ubuntu-latest
    
    # ------------------------------------------------------------------------------------
    # æƒé™ï¼ˆPermissionsï¼‰
    # ------------------------------------------------------------------------------------
    permissions:
      pull-requests: write # å…è®¸è¯„è®ºã€åˆå¹¶å’Œå…³é—­ PRã€‚
      contents: write      # å…è®¸åˆå¹¶ PR (å› ä¸ºåˆå¹¶æ“ä½œä¼šå†™å…¥ base åˆ†æ”¯)ã€‚

    steps:
      - name: "Checkout: å…‹éš†ä»£ç ä»“åº“"
        uses: actions/checkout@v4

      - name: "Setup: æ ¡éªŒä¾èµ–å·¥å…·"
        run: |
          set -euo pipefail
          gh --version
          jq --version
          echo "âœ… æ‰€æœ‰ä¾èµ–å·¥å…·å‡å¯ç”¨ã€‚"

      - name: "Step 1: æå– PR å…³é”®ä¿¡æ¯"
        id: pr-info
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"
          PR_HEAD_SHA="${{ github.event.check_suite.head_sha }}"
          
          if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä»äº‹ä»¶ä¸­æ‰¾åˆ°å…³è”çš„ PR ç¼–å·æˆ–å¤´éƒ¨æäº¤ SHAã€‚"
            exit 1
          fi
          
          BASE_BRANCH=$(gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName')
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_head_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Step 2: è·å– Dependabot å…ƒæ•°æ®"
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.2.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      # ========================================================================================
      # â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æ ¸å¿ƒå†³ç­–å¼•æ“ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
      # ========================================================================================
      - name: "Step 3: Decision Engine & Report Generator"
        id: engine
        run: | # <-- å…³é”®ä¿®å¤ï¼šä½¿ç”¨ `|` å£°æ˜è¿™æ˜¯ä¸€ä¸ªå¤šè¡Œè„šæœ¬ï¼Œé¿å…YAMLè§£æé”™è¯¯
          set -euo pipefail
          echo "ğŸ§  [Decision Engine] å¼€å§‹åˆ†æ PR #${{ steps.pr-info.outputs.pr_number }}..."
          
          # --- 1. ä¿¡æ¯æ”¶é›† ---
          ALL_CHECKS_JSON=$(gh api "repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_head_sha }}/check-runs" --jq '.check_runs')
          REQUIRED_CHECKS_JSON=$(gh api "repos/${{ github.repository }}/branches/${{ steps.pr-info.outputs.base_branch }}/protection" --jq '.required_status_checks.contexts' 2>/dev/null || echo "[]")
          UPDATE_TYPE="${{ steps.dependabot-metadata.outputs.update-type }}"
          
          DECISION="CLOSE" # é»˜è®¤å†³ç­–ä¸ºå…³é—­ï¼Œé™¤éæ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³
          CHECKS_PASSED=false
          FAILURE_REASON=""

          # --- 2. æ£€æŸ¥CIçŠ¶æ€ ---
          if [[ "$(echo "$REQUIRED_CHECKS_JSON" | jq 'if type=="array" and length==0 then "empty" else "ok" end')" == '"empty"' ]]; then
            # --- åœºæ™¯ä¸€ï¼šæ²¡æœ‰é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ ---
            echo "â„¹ï¸ åœºæ™¯ï¼šæœªé…ç½®å¿…éœ€æ£€æŸ¥ã€‚å°†æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•æ˜ç¡®å¤±è´¥(failure)çš„æ£€æŸ¥é¡¹ã€‚"
            if echo "$ALL_CHECKS_JSON" | jq -e 'any(.conclusion == "failure")'; then
              FAILED_CHECKS=$(echo "$ALL_CHECKS_JSON" | jq -r '[.[] | select(.conclusion == "failure") | "`" + .name + "` (çŠ¶æ€: `failure`)"] | join("\n- ")')
              FAILURE_REASON="ä¸€ä¸ªæˆ–å¤šä¸ªCIæ£€æŸ¥æ˜ç¡®å¤±è´¥äº†:\n- $FAILED_CHECKS"
            else
              CHECKS_PASSED=true
            fi
          else
            # --- åœºæ™¯äºŒï¼šå·²é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ ---
            echo "â„¹ï¸ åœºæ™¯ï¼šå·²é…ç½®å¿…éœ€æ£€æŸ¥ã€‚å°†ä¸¥æ ¼éªŒè¯æ‰€æœ‰è§„åˆ™ã€‚"
            REQUIRED_CHECKS=$(echo "$REQUIRED_CHECKS_JSON" | jq -r '.[]')
            FAILED_CHECKS=""
            while IFS= read -r CHECK_NAME; do
              CONCLUSION=$(echo "$ALL_CHECKS_JSON" | jq -r --arg name "$CHECK_NAME" '(.[] | select(.name == $name)) | .conclusion' | tail -n 1)
              if [[ "$CONCLUSION" != "success" ]]; then
                FAILED_CHECKS+="- å¿…éœ€æ£€æŸ¥ \`$CHECK_NAME\` æœªé€šè¿‡ (å®é™…çŠ¶æ€: \`${CONCLUSION:-Not Found}\`).\n"
              fi
            done <<< "$REQUIRED_CHECKS"
            
            if [ -z "$FAILED_CHECKS" ]; then
              CHECKS_PASSED=true
            else
              FAILURE_REASON="ä¸€ä¸ªæˆ–å¤šä¸ªå¿…éœ€çš„åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥æœªé€šè¿‡:\n$FAILED_CHECKS"
            fi
          fi

          # --- 3. æ ¹æ®CIç»“æœå’Œæ›´æ–°ç±»å‹åšå‡ºæœ€ç»ˆå†³ç­– ---
          if $CHECKS_PASSED; then
            echo "âœ… æ‰€æœ‰ç›¸å…³æ£€æŸ¥å‡å·²é€šè¿‡ã€‚"
            if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
              DECISION="REVIEW"
            else
              DECISION="MERGE"
            fi
          else
            echo "âŒ æ£€æŸ¥æœªé€šè¿‡ã€‚å†³ç­–ï¼šå…³é—­PRã€‚"
            DECISION="CLOSE"
          fi

          # --- 4. ç”Ÿæˆè¯¦ç»†çš„æŠ¥å‘Šå†…å®¹ ---
          # ä¸ºäº†åœ¨bashè„šæœ¬ä¸­å®‰å…¨åœ°å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ç§æ›´å¥å£®çš„æ–¹å¼æ¥ç”ŸæˆæŠ¥å‘Š
          delimiter=$(openssl rand -hex 8) # ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å®šç•Œç¬¦
          
          generate_report() {
            case "$1" in
              MERGE)
                SUCCESS_CHECKS=$(echo "$ALL_CHECKS_JSON" | jq -r '[.[] | select(.conclusion == "success") | "`" + .name + "`"] | join(", ")')
                cat <<EOF
          âœ… **å¤©æ–‡å°æŠ¥å‘Šï¼šè‡ªåŠ¨åˆå¹¶å·²å¯ç”¨**

          æ‰€æœ‰å¿…éœ€çš„CIæ£€æŸ¥å‡å·²é€šè¿‡ï¼Œä¸”æ­¤æ›´æ–°ä¸º **éé‡å¤§ç‰ˆæœ¬æ›´æ–°** (\`${UPDATE_TYPE}\`)ã€‚å·²ä¸ºæ­¤PRå¯ç”¨è‡ªåŠ¨åˆå¹¶ï¼ˆAuto-mergeï¼‰ã€‚

          ---
          **âœ” é€šè¿‡çš„æ£€æŸ¥é¡¹:**
          ${SUCCESS_CHECKS}
          EOF
                ;;
              REVIEW)
                SUCCESS_CHECKS=$(echo "$ALL_CHECKS_JSON" | jq -r '[.[] | select(.conclusion == "success") | "`" + .name + "`"] | join(", ")')
                cat <<EOF
          âš ï¸ **å¤©æ–‡å°æŠ¥å‘Šï¼šéœ€è¦äººå·¥å®¡æŸ¥**

          æ‰€æœ‰å¿…éœ€çš„CIæ£€æŸ¥å‡å·²é€šè¿‡ï¼Œä½†è¿™æ˜¯ä¸€ä¸ª **é‡å¤§ç‰ˆæœ¬æ›´æ–°** (major version update)ï¼Œå¯èƒ½åŒ…å«ä¸å…¼å®¹çš„å˜æ›´ï¼Œéœ€è¦äººå·¥å®¡æŸ¥å’Œæ‰¹å‡†åæ‰èƒ½åˆå¹¶ã€‚

          ---
          **âœ” é€šè¿‡çš„æ£€æŸ¥é¡¹:**
          ${SUCCESS_CHECKS}
          EOF
                ;;
              CLOSE)
                WORKFLOW_URL="https://github.com/${{ github.repository }}/pull/${{ steps.pr-info.outputs.pr_number }}/checks"
                cat <<EOF
          ğŸš¨ **å¤©æ–‡å°æŠ¥å‘Šï¼šè‡ªåŠ¨å…³é—­**

          æ£€æµ‹åˆ°CIæ£€æŸ¥å­˜åœ¨é—®é¢˜ï¼Œæ­¤ PR å°†è¢«è‡ªåŠ¨å…³é—­ã€‚

          ---
          **ğŸ“‹ è¯Šæ–­æŠ¥å‘Š:**
          ${FAILURE_REASON}
          ---
          è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥å®¡æŸ¥æ‰€æœ‰æ£€æŸ¥é¡¹çš„è¯¦ç»†æƒ…å†µï¼š
          **[æŸ¥çœ‹æ‰€æœ‰ PR æ£€æŸ¥](${WORKFLOW_URL})**
          EOF
                ;;
            esac
          }

          REPORT_BODY=$(generate_report "$DECISION")

          # --- 5. è®¾ç½®è¾“å‡º ---
          echo "å†³ç­–: $DECISION"
          # ä½¿ç”¨HEREDOCå°†å¤šè¡Œå­—ç¬¦ä¸²èµ‹å€¼ç»™GITHUB_OUTPUT
          {
            echo "decision=$DECISION"
            echo "report_body<<$delimiter"
            echo "$REPORT_BODY"
            echo "$delimiter"
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ========================================================================================
      # â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ç»Ÿä¸€æ‰§è¡Œæ“ä½œ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
      # ========================================================================================
      - name: "Step 4: Execute Decision"
        run: | # <-- å…³é”®ä¿®å¤ï¼šä½¿ç”¨ `|`
          set -euo pipefail
          DECISION="${{ steps.engine.outputs.decision }}"
          REPORT_BODY="${{ steps.engine.outputs.report_body }}"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          echo "ğŸ¬ æ‰§è¡Œå†³ç­–: $DECISION"
          
          # å§‹ç»ˆå…ˆå‘è¡¨è¯„è®º
          echo "å‘è¡¨è¯„è®º..."
          # ä½¿ç”¨ --body-file - æ¥ä»æ ‡å‡†è¾“å…¥è¯»å–å¤šè¡Œæ­£æ–‡ï¼Œè¿™æ˜¯æœ€å®‰å…¨çš„æ–¹å¼
          echo "$REPORT_BODY" | gh pr comment "$PR_NUMBER" --body-file -

          # æ ¹æ®å†³ç­–æ‰§è¡Œç›¸åº”æ“ä½œ
          case $DECISION in
            MERGE)
              echo "å¯ç”¨è‡ªåŠ¨åˆå¹¶..."
              gh pr merge "$PR_NUMBER" --auto --squash
              ;;
            REVIEW)
              echo "æ“ä½œå®Œæˆï¼Œç­‰å¾…äººå·¥å®¡æŸ¥ã€‚"
              ;;
            CLOSE)
              echo "å…³é—­PR..."
              gh pr close "$PR_NUMBER"
              ;;
          esac
          echo "âœ… æ“ä½œæ‰§è¡Œå®Œæ¯•ã€‚"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}